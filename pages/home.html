<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="../assets/images/logo-icon.png">
    <title>Home - Question Paper Bee</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/animations.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>

    <div id="initialLoader"
        style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; background:#000; color:#fff; position:fixed; top:0; left:0; width:100%; z-index:9999;">
        <div class="loader-spinner"
            style="width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid var(--yellow); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px;">
        </div>
        <p style="font-family: 'Inter', sans-serif; font-size: 0.9rem; color: #888;">Preparing your workspace...</p>
        <style>
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }

                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
    </div>

    <div class="app-container" style="display:none;" id="mainApp">


        <header class="app-header">
            <div class="header-left">

            </div>
            <div class="header-center">
                <h1 class="app-logo-text">BEEPREPARE</h1>
            </div>
            <div class="header-right">
                <a href="profile.html">
                    <img src="../assets/images/avatar-placeholder.png" alt="Profile" class="profile-avatar">
                </a>
            </div>
        </header>


        <main class="main-content fade-in">
            <div style="padding-bottom: 20px;">


                <section class="section-home">
                    <div class="section-header">
                        <h2 class="section-title">Your Subjects</h2>

                        <a href="profile.html" style="opacity:0.5; color: inherit;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                        </a>
                    </div>
                    <div id="homeSubjectsGrid" class="subjects-grid">
                        <div style="color:#666; font-size:0.9rem;">Loading...</div>
                    </div>
                </section>


                <section class="section-home" style="margin-top: 32px;">
                    <div class="section-header">
                        <h2 class="section-title">Classes You Teach</h2>
                        <a href="profile.html" class="icon-btn edit">
                            <img src="../assets/images/icon-edit.svg" width="18" alt="Edit">

                        </a>
                    </div>
                    <div id="homeClassesContainer" class="classes-scroll-container">
                        <div style="color:#666; font-size:0.9rem;">Loading...</div>
                    </div>
                </section>


                <section class="section-home" style="margin-top: 32px;">
                    <div class="section-header">
                        <h2 class="section-title">Your Activity</h2>
                    </div>
                    <div class="activity-list">

                        <div class="activity-item highlight">
                            <div class="activity-dot"></div>
                            <div class="activity-content">
                                <div class="activity-title">Logged In</div>
                                <div class="activity-time">Just now</div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>


        <nav class="bottom-nav">
            <a href="home.html" class="nav-item active">
                <img src="../assets/images/icon-home.svg" class="nav-icon" alt="Home">
                <span>Home</span>
            </a>
            <a href="question-bank.html" class="nav-item">
                <img src="../assets/images/icon-bank.svg" class="nav-icon" alt="Bank">
                <span>Bank</span>
            </a>
            <a href="blueprint.html" class="nav-item">
                <img src="../assets/images/icon-plus.svg" class="nav-icon" alt="Generate">
                <span>Generate</span>
            </a>
            <a href="profile.html" class="nav-item">
                <img src="../assets/images/icon-profile.svg" class="nav-icon" alt="Profile">
                <span>Profile</span>
            </a>
        </nav>

    </div>

    <script type="module">
        import { auth, onAuthStateChanged } from '../assets/js/firebase-auth.js';
        import { getUserProfileData, getUserActivity } from '../assets/js/firestore.js';
        import { getSubjectIcon, getSubjectColor } from '../assets/js/icons.js';

        const initHome = async (user) => {
            if (!user) return;

            try {
                const [profile, activity] = await Promise.all([
                    getUserProfileData(user.uid),
                    getUserActivity(user.uid, 5)
                ]);

                const isPremium = profile?.isPremium === true;
                if (!isPremium) {
                    console.log("User is not premium. Redirecting to activation.");
                    window.location.replace('activate.html');
                    return;
                }

                renderSubjects(profile ? profile.subjects : []);
                renderClasses(profile ? profile.classes : []);
                renderActivity(activity);

                const loader = document.getElementById('initialLoader');
                if (loader) loader.style.display = 'none';

                document.getElementById('mainApp').style.display = 'block';

            } catch (e) {
                console.error("Home load error", e);
                const loader = document.getElementById('initialLoader');
                if (loader) {
                    loader.innerHTML = `<div style="color:var(--danger); text-align:center; padding:20px;">
                        <p>Error loading profile.</p>
                        <p style="font-size:0.8rem; margin-top:8px;">${e.message}</p>
                        <button onclick="window.location.reload()" style="margin-top:16px; padding:8px 16px; background:#333; border:none; color:#fff; border-radius:4px; cursor:pointer;">Retry</button>
                    </div>`;
                }
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                initHome(user);
            } else {
                console.log("Waiting for auth redirect...");
            }
        });

        const renderActivity = (activities) => {
            const container = document.querySelector('.activity-list');
            if (!container) return;
            container.innerHTML = '';

            if (!activities || activities.length === 0) {
                container.innerHTML = '<div style="color:var(--text-secondary); font-size:0.9rem; text-align:center; padding:10px;">No recent activity.</div>';
                return;
            }

            activities.forEach(act => {
                let timeStr = 'Just now';
                if (act.timestamp) {
                    const date = act.timestamp.toDate ? act.timestamp.toDate() : new Date(act.timestamp);
                    const now = new Date();
                    const diffMins = Math.floor((now - date) / 60000);
                    if (diffMins < 1) timeStr = 'Just now';
                    else if (diffMins < 60) timeStr = `${diffMins} min ago`;
                    else if (diffMins < 1440) timeStr = `${Math.floor(diffMins / 60)} hr ago`;
                    else timeStr = date.toLocaleDateString();
                }

                const item = document.createElement('div');
                item.className = 'activity-item highlight';
                item.style.animation = 'fadeIn 0.5s ease forwards';
                item.innerHTML = `
                    <div class="activity-dot"></div>
                    <div class="activity-content">
                        <div class="activity-title">${act.title}</div>
                        <div style="font-size:0.85rem; color:var(--text-secondary); margin-top:2px;">${act.detail}</div>
                        <div class="activity-time">${timeStr}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        };

        const renderSubjects = (subjects) => {
            const container = document.getElementById('homeSubjectsGrid');
            if (!container) return;
            container.innerHTML = '';

            if (!subjects || subjects.length === 0) {
                container.innerHTML = '<div style="color:var(--text-secondary); font-size:0.9rem;">No subjects selected. <a href="profile.html" style="color:var(--yellow)">Edit Profile</a></div>';
                return;
            }

            subjects.forEach(sub => {
                const iconHtml = getSubjectIcon(sub);
                const color = getSubjectColor(sub);

                const div = document.createElement('div');
                div.className = 'subject-card';
                div.innerHTML = `
                    <div class="subject-icon" style="
                        background-color: ${color}20; 
                        width: 56px; 
                        height: 56px; 
                        border-radius: 50%; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center;
                        color: ${color};
                        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
                        margin-bottom: 8px;
                        border: 1px solid ${color}40;
                    ">
                            ${iconHtml}
                    </div>
                    <span class="subject-name" style="font-weight: 600; font-size: 0.9rem;">${sub}</span>
                    `;
                container.appendChild(div);
            });
        };

        const renderClasses = (classes) => {
            const container = document.getElementById('homeClassesContainer');
            if (!container) return;
            container.innerHTML = '';

            if (!classes || classes.length === 0) {
                container.innerHTML = '<div style="color:var(--text-secondary); font-size:0.9rem;">No classes selected. <a href="profile.html" style="color:var(--yellow)">Edit Profile</a></div>';
                return;
            }

            classes.forEach(cls => {
                const div = document.createElement('div');
                div.className = 'class-card';
                div.innerHTML = `
                    <div>
                        <div class="class-name">${cls}</div>
                        <div class="class-section">Enrolled</div>
                    </div>
                `;
                container.appendChild(div);
            });
        };
    </script>
    <script type="module" src="../assets/js/firebase-auth.js"></script>
    <script src="../assets/js/app_security.js"></script>
</body>

</html>