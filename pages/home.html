<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="../assets/images/logo-icon.png">
    <title>Home - Question Paper Bee</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/animations.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>

    <div id="initialLoader"
        style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; background:#000; color:#fff; position:fixed; top:0; left:0; width:100%; z-index:9999;">
        <div class="loader-spinner"
            style="width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid var(--yellow); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px;">
        </div>
        <p style="font-family: 'Inter', sans-serif; font-size: 0.9rem; color: #888;">Preparing your workspace...</p>
        <style>
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }

                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
    </div>

    <div class="app-container" style="display:none;" id="mainApp">


        <header class="app-header">
            <div class="header-left">

            </div>
            <div class="header-center">
                <h1 class="app-logo-text">BEEPREPARE</h1>
            </div>
            <div class="header-right">
                <a href="profile.html">
                    <img src="../assets/images/avatar-placeholder.png" alt="Profile" class="profile-avatar">
                </a>
            </div>
        </header>


        <main class="main-content fade-in">
            <div style="padding-bottom: 20px;">


                <section class="section-home">
                    <div class="section-header">
                        <h2 class="section-title">Your Subjects</h2>

                        <a href="profile.html" style="opacity:0.5; color: inherit;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                        </a>
                    </div>
                    <div id="homeSubjectsGrid" class="subjects-grid">
                        <div style="color:#666; font-size:0.9rem;">Loading...</div>
                    </div>
                </section>


                <section class="section-home" style="margin-top: 32px;">
                    <div class="section-header">
                        <h2 class="section-title">Classes You Teach</h2>
                        <a href="profile.html" class="icon-btn edit">
                            <img src="../assets/images/icon-edit.svg" width="18" alt="Edit">

                        </a>
                    </div>
                    <div id="homeClassesContainer" class="classes-scroll-container">
                        <div style="color:#666; font-size:0.9rem;">Loading...</div>
                    </div>
                </section>


                <section class="section-home" style="margin-top: 32px;">
                    <div class="section-header">
                        <h2 class="section-title">Your Activity</h2>
                    </div>
                    <div class="activity-list">

                        <div class="activity-item highlight">
                            <div class="activity-dot"></div>
                            <div class="activity-content">
                                <div class="activity-title">Logged In</div>
                                <div class="activity-time">Just now</div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>


        <nav class="bottom-nav">
            <a href="home.html" class="nav-item active">
                <img src="../assets/images/icon-home.svg" class="nav-icon" alt="Home">
                <span>Home</span>
            </a>
            <a href="question-bank.html" class="nav-item">
                <img src="../assets/images/icon-bank.svg" class="nav-icon" alt="Bank">
                <span>Bank</span>
            </a>
            <a href="blueprint.html" class="nav-item">
                <img src="../assets/images/icon-plus.svg" class="nav-icon" alt="Generate">
                <span>Generate</span>
            </a>
            <a href="profile.html" class="nav-item">
                <img src="../assets/images/icon-profile.svg" class="nav-icon" alt="Profile">
                <span>Profile</span>
            </a>
        </nav>

    </div>

    <!-- failsafe script: runs independently of modules -->
    <script>
        window.appLoadTimer = setTimeout(() => {
            const loader = document.getElementById('initialLoader');
            if (loader && loader.style.display !== 'none') {
                const p = loader.querySelector('p');
                if (p) {
                    p.innerHTML = `
                        <span style='color:#ff4444; font-weight:bold; font-size:1.1rem;'>Connection Timeout</span>
                        <div style="margin-top:12px; color:#ccc; font-size:0.9rem;">
                            The app takes longer than expected to load.<br>
                            This could be due to a slow network or a cache issue.
                        </div>
                    `;

                    const btnContainer = document.createElement('div');
                    btnContainer.style.marginTop = "24px";
                    btnContainer.style.display = "flex";
                    btnContainer.style.gap = "12px";
                    btnContainer.style.justifyContent = "center";

                    const btnReload = document.createElement('button');
                    btnReload.innerText = "Try Reloading";
                    btnReload.style.padding = "10px 20px";
                    btnReload.style.borderRadius = "8px";
                    btnReload.style.border = "none";
                    btnReload.style.fontWeight = "600";
                    btnReload.style.cursor = "pointer";
                    btnReload.style.background = "#F59E0B";
                    btnReload.style.color = "#000";
                    btnReload.onclick = () => window.location.reload();

                    const btnReset = document.createElement('button');
                    btnReset.innerText = "Reset App Data";
                    btnReset.style.padding = "10px 20px";
                    btnReset.style.borderRadius = "8px";
                    btnReset.style.border = "1px solid #ff4444";
                    btnReset.style.fontWeight = "600";
                    btnReset.style.cursor = "pointer";
                    btnReset.style.background = "transparent";
                    btnReset.style.color = "#ff4444";

                    btnReset.onclick = () => {
                        if (confirm("This will clear your local app data and log you out. Continue?")) {
                            localStorage.clear();
                            sessionStorage.clear();
                            // Attempt to clear service workers if any (though we aren't using them explicitly yet)
                            if ('serviceWorker' in navigator) {
                                navigator.serviceWorker.getRegistrations().then(function (registrations) {
                                    for (let registration of registrations) {
                                        registration.unregister();
                                    }
                                });
                            }
                            window.location.href = 'login.html';
                        }
                    };

                    btnContainer.appendChild(btnReload);
                    btnContainer.appendChild(btnReset);
                    p.appendChild(btnContainer);
                }
                console.error("App load timeout triggered via failsafe.");
            }
        }, 20000); // Increased to 20 seconds
    </script>

    <script type="module">
        import { auth, onAuthStateChanged } from '../assets/js/firebase-auth.js';
        import { getUserProfileData, getUserActivity } from '../assets/js/firestore.js';
        import { getSubjectIcon, getSubjectColor } from '../assets/js/icons.js';

        const initHome = async (user) => {
            if (!user) return;

            try {
                console.log("Initializing Home for user:", user.uid);

                const [profile, activity] = await Promise.all([
                    getUserProfileData(user.uid).catch(e => null),
                    getUserActivity(user.uid, 5).catch(e => [])
                ]);

                // Clear the failsafe timer
                if (window.appLoadTimer) clearTimeout(window.appLoadTimer);

                const isPremium = profile?.isPremium === true;
                if (!isPremium) {
                    console.log("User is not premium. Redirecting to activation.");
                    const loaderP = document.querySelector('#initialLoader p');
                    if (loaderP) loaderP.textContent = "Account not activated. Redirecting...";
                    setTimeout(() => window.location.replace('activate.html'), 1000);
                    return;
                }

                renderSubjects(profile ? profile.subjects : []);
                renderClasses(profile ? profile.classes : []);
                renderActivity(activity);

                const loader = document.getElementById('initialLoader');
                if (loader) {
                    loader.style.opacity = '0';
                    loader.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => { loader.style.display = 'none'; }, 500);
                }

                const mainApp = document.getElementById('mainApp');
                mainApp.style.display = 'block';
                mainApp.style.opacity = 0;
                requestAnimationFrame(() => {
                    mainApp.style.transition = 'opacity 0.5s ease';
                    mainApp.style.opacity = 1;
                });

            } catch (e) {
                console.error("Home load critical error", e);
                if (window.appLoadTimer) clearTimeout(window.appLoadTimer);

                const loader = document.getElementById('initialLoader');
                if (loader) {
                    loader.innerHTML = `<div style="color:#ff4444; text-align:center; padding:20px;">
                        <p style="font-size:1.1rem; font-weight:600;">Unable to load profile</p>
                        <p style="font-size:0.8rem; margin-top:8px; color:#aaa;">${e.message || "Unknown Network Error"}</p>
                        <button onclick="window.location.reload()" style="margin-top:20px; padding:10px 20px; background:#f59e0b; border:none; color:#000; font-weight:bold; border-radius:6px; cursor:pointer;">Retry Connection</button>
                    </div>`;
                }
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Determine if we need to clear the timer immediately or wait for data
                // We wait for data in initHome, so simply calling initHome is enough.
                initHome(user);
            } else {
                console.log("Waiting for auth redirect...");
                // If user is null, firebase-auth.js handles redirect. 
                // However, if that fails, we might still be stuck. 
                // The global timeout will catch this case too.
            }
        });

        const renderActivity = (activities) => {
            const container = document.querySelector('.activity-list');
            if (!container) return;
            container.innerHTML = '';

            if (!activities || activities.length === 0) {
                container.innerHTML = '<div style="color:var(--text-secondary); font-size:0.9rem; text-align:center; padding:10px;">No recent activity.</div>';
                return;
            }

            activities.forEach(act => {
                let timeStr = 'Just now';
                if (act.timestamp) {
                    const date = act.timestamp.toDate ? act.timestamp.toDate() : new Date(act.timestamp);
                    const now = new Date();
                    const diffMins = Math.floor((now - date) / 60000);
                    if (diffMins < 1) timeStr = 'Just now';
                    else if (diffMins < 60) timeStr = `${diffMins} min ago`;
                    else if (diffMins < 1440) timeStr = `${Math.floor(diffMins / 60)} hr ago`;
                    else timeStr = date.toLocaleDateString();
                }

                const item = document.createElement('div');
                item.className = 'activity-item highlight';
                item.style.animation = 'fadeIn 0.5s ease forwards';
                item.innerHTML = `
                    <div class="activity-dot"></div>
                    <div class="activity-content">
                        <div class="activity-title">${act.title}</div>
                        <div style="font-size:0.85rem; color:var(--text-secondary); margin-top:2px;">${act.detail}</div>
                        <div class="activity-time">${timeStr}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        };

        const renderSubjects = (subjects) => {
            const container = document.getElementById('homeSubjectsGrid');
            if (!container) return;
            container.innerHTML = '';

            if (!subjects || subjects.length === 0) {
                container.innerHTML = '<div style="color:var(--text-secondary); font-size:0.9rem;">No subjects selected. <a href="profile.html" style="color:var(--yellow)">Edit Profile</a></div>';
                return;
            }

            subjects.forEach(sub => {
                const iconHtml = getSubjectIcon(sub);
                const color = getSubjectColor(sub);

                const div = document.createElement('div');
                div.className = 'subject-card';
                div.innerHTML = `
                    <div class="subject-icon" style="
                        background-color: ${color}20; 
                        width: 56px; 
                        height: 56px; 
                        border-radius: 50%; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center;
                        color: ${color};
                        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
                        margin-bottom: 8px;
                        border: 1px solid ${color}40;
                    ">
                            ${iconHtml}
                    </div>
                    <span class="subject-name" style="font-weight: 600; font-size: 0.9rem;">${sub}</span>
                    `;
                container.appendChild(div);
            });
        };

        const renderClasses = (classes) => {
            const container = document.getElementById('homeClassesContainer');
            if (!container) return;
            container.innerHTML = '';

            if (!classes || classes.length === 0) {
                container.innerHTML = '<div style="color:var(--text-secondary); font-size:0.9rem;">No classes selected. <a href="profile.html" style="color:var(--yellow)">Edit Profile</a></div>';
                return;
            }

            classes.forEach(cls => {
                const div = document.createElement('div');
                div.className = 'class-card';
                div.innerHTML = `
                    <div>
                        <div class="class-name">${cls}</div>
                        <div class="class-section">Enrolled</div>
                    </div>
                `;
                container.appendChild(div);
            });
        };
    </script>
    <script src="../assets/js/app_security.js"></script>
</body>

</html>