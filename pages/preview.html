<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preview - BEEPREPARE</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/animations.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="icon" type="image/png" href="../assets/images/logo-icon.png">
    <style>
        .page-container {
            max-width: 480px;
            margin: 0 auto;
            width: 100%;
        }


        :root {
            --paper-content-size: 10pt;
        }

        .p-q-text {
            font-size: var(--paper-content-size) !important;
            margin-bottom: 2px !important;
        }

        .p-q-num {
            font-size: var(--paper-content-size) !important;
        }

        .mcq-options-grid {
            font-size: var(--paper-content-size) !important;
        }

        .paper-question-item {
            gap: 4px !important;
            margin-bottom: 4px !important;
        }


        .paper-promo-footer {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8pt;
            color: rgba(0, 0, 0, 0.3);
            font-weight: 600;
            pointer-events: none;

            user-select: none;
        }
    </style>
</head>

<body>

    <div id="drawer">

    </div>

    <div class="app-container">


        <header class="app-header">
            <div class="header-left">
                <a href="blueprint.html" class="menu-trigger" style="padding: 4px;">
                    <img src="../assets/images/icon-arrow-left.svg" alt="Back" style="width: 24px;">
                </a>
            </div>
            <div class="header-center">
                <h1 class="app-logo-text">Paper Preview</h1>
            </div>
            <div class="header-right">
                <a href="#" class="menu-trigger">
                    <img src="../assets/images/icon-edit.svg" alt="Edit" style="width: 20px; filter: grayscale(1);">
                </a>
            </div>
        </header>

        <main class="main-content fade-in" style="background-color: var(--dark-bg); position: relative;">

            <div class="preview-container-wrapper">


                <div class="a4-paper">


                    <div class="paper-header-section">

                    </div>


                    <div class="paper-question-list">

                    </div>


                    <div class="paper-promo-footer">BS</div>
                </div>
            </div>


            <div style="height: 60px;"></div>

        </main>



        <div class="action-bar"
            style="position: fixed; bottom: 0; left: 0; width: 100%; padding: 16px; background: var(--card-grey); border-top: 1px solid var(--border-grey); display: flex; gap: 12px; align-items: center; justify-content: center; z-index: 100;">


            <div style="display: flex; flex-direction: column; gap: 2px; flex: 0.8; margin-right: 8px;">
                <div
                    style="display:flex; justify-content: space-between; color: var(--text-secondary); font-size: 0.75rem;">
                    <span>Size</span>
                    <span id="fontSizeDisplay">10pt</span>
                </div>
                <input type="range" id="fontSizeSlider" min="8" max="16" step="0.5" value="10"
                    style="width: 100%; cursor: pointer; accent-color: var(--primary);">
            </div>

            <button class="btn btn-primary" style="flex: 1;">Finalize Paper</button>
            <button class="btn btn-disabled" style="flex: 1;" disabled>Download PDF</button>
        </div>

    </div>

    <script type="module">
        import { getPaperDraft } from '../assets/js/createPaper.js';
        import { enableEditMode, disableEditMode, scrapePaperData } from '../assets/js/previewEditor.js';
        import { saveFinalPaper } from '../assets/js/paperSave.js';
        import { generateQuestionPaperPDF } from '../assets/js/pdfGenerator.js';
        import { getUserProfileData } from '../assets/js/firestore.js';

        const checkAccess = async () => {
            const userJson = localStorage.getItem('qp_user');
            if (!userJson) {
                window.location.replace('login.html');
                return;
            }
            const user = JSON.parse(userJson);
            try {
                const profile = await getUserProfileData(user.uid);
                if (!profile || !profile.isPremium) {
                    window.location.replace('activate.html');
                }
            } catch (e) {
                window.location.replace('login.html');
            }
        };
        checkAccess();

        let currentDraft = null;

        document.addEventListener('DOMContentLoaded', () => {
            currentDraft = getPaperDraft();
            if (!currentDraft) {
                if (confirm("No active paper draft found. Create one now?")) {
                    window.location.href = "blueprint.html";
                }
                return;
            }

            renderPaper(currentDraft);

            enableEditMode();

            const fontSizeSlider = document.getElementById('fontSizeSlider');
            const sizeDisplay = document.getElementById('fontSizeDisplay');
            const paperRoot = document.documentElement;

            if (fontSizeSlider) {
                fontSizeSlider.addEventListener('input', (e) => {
                    const newSize = e.target.value;
                    paperRoot.style.setProperty('--paper-content-size', `${newSize}pt`);
                    if (sizeDisplay) sizeDisplay.textContent = `${newSize}pt`;
                });
            }
        });

        const renderPaper = (draft) => {
            const headerSection = document.querySelector('.paper-header-section');
            if (headerSection) {
                headerSection.innerHTML = `
                    <div class="paper-inst-name">${draft.institution || "St. Xavier's High School"}</div>
                    <div class="paper-exam-name">${draft.examName || "Mid-Term Examination 2026"}</div>
                    
                    <div class="student-details-header">
                        <div class="detail-line">Name: <span></span></div>
                        <div class="detail-line">Roll No: <span></span></div>
                    </div>

                    <div class="paper-meta-grid">
                        <span>Class: ${draft.class} | Subject: ${draft.subject}</span>
                        <span>Marks: ${draft.totalMarks} | Time: ${Math.ceil(draft.totalMarks * 1.5)} Mins</span>
                    </div>
                `;
            }

            const container = document.querySelector('.paper-question-list');
            if (!container) return;
            container.innerHTML = '';

            let globalQCount = 1;

            const renderGroup = (label, typeFilter, marksDisplay) => {
                let subset = [];

                if (typeFilter === "MCQ") {
                    subset = draft.questions.filter(q => q.questionType === "MCQ" || q.marks === "MCQ");
                } else {
                    subset = draft.questions.filter(q => q.marks == typeFilter && q.questionType !== "MCQ" && q.marks !== "MCQ");
                }

                if (subset.length === 0) return;

                const sectionHeader = document.createElement('div');
                sectionHeader.style.cssText = "text-align: center; font-weight: 700; margin: 12px 0 8px 0; text-decoration: underline; font-size: 11pt;";
                sectionHeader.textContent = `${label} (${marksDisplay} Marks Each)`;
                container.appendChild(sectionHeader);

                subset.forEach(q => {
                    const el = document.createElement('div');
                    el.className = 'paper-question-item';
                    el.dataset.id = q.id || 'temp';

                    let optionsHtml = '';
                    if (q.options && typeof q.options === 'object') {
                        optionsHtml = `
                            <div class="mcq-options-grid">
                                <div class="mcq-option"><span>(A)</span> ${q.options.A}</div>
                                <div class="mcq-option"><span>(B)</span> ${q.options.B}</div>
                                <div class="mcq-option"><span>(C)</span> ${q.options.C}</div>
                                <div class="mcq-option"><span>(D)</span> ${q.options.D}</div>
                            </div>
                        `;
                    }

                    el.innerHTML = `
                        <div class="p-q-num">${globalQCount++}.</div>
                        <div class="p-q-content">
                            <div class="p-q-text">${q.questionText}</div>
                            ${optionsHtml}
                        </div>
                        <div class="p-q-marks">[${(q.marks === 'MCQ' || q.questionType === 'MCQ') ? 1 : q.marks}]</div>
                    `;
                    container.appendChild(el);
                });
            };

            if (draft.sectionOrder && Array.isArray(draft.sectionOrder)) {
                const sectionLabels = ["SECTION A", "SECTION B", "SECTION C", "SECTION D"];
                draft.sectionOrder.forEach((type, index) => {
                    let marksDisplay = type === "MCQ" ? 1 : parseInt(type);
                    if (isNaN(marksDisplay)) marksDisplay = 1;
                    renderGroup(sectionLabels[index], type, marksDisplay);
                });
            } else {
                renderGroup("SECTION A", "MCQ", 1);
                renderGroup("SECTION B", "2", 2);
                renderGroup("SECTION C", "4", 4);
                renderGroup("SECTION D", "6", 6);
            }

            if (container.children.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px;">No questions in draft.</div>';
            }
        };

        const finalizeBtn = document.querySelector('.btn-primary');
        const pdfBtn = document.querySelector('.btn-disabled');

        if (finalizeBtn) {
            finalizeBtn.addEventListener('click', async () => {
                if (finalizeBtn.disabled) return;

                const originalText = finalizeBtn.textContent;
                finalizeBtn.textContent = "Saving...";
                finalizeBtn.disabled = true;

                try {
                    const finalData = scrapePaperData(currentDraft);

                    disableEditMode();

                    const paperId = await saveFinalPaper(finalData);

                    if (paperId) {
                        finalizeBtn.textContent = "Finalized";
                        currentDraft = { ...currentDraft, ...finalData };

                        if (pdfBtn) {
                            pdfBtn.disabled = false;
                            pdfBtn.classList.remove('btn-disabled');
                            pdfBtn.classList.add('btn-primary');
                            pdfBtn.style.backgroundColor = 'var(--text-primary)';
                            pdfBtn.style.color = '#000';
                            pdfBtn.textContent = "Generate PDF";
                        }
                    } else {
                        throw new Error("Save returned null");
                    }

                } catch (e) {
                    console.error(e);
                    alert("Error finalizing paper: " + e.message);
                    finalizeBtn.disabled = false;
                    finalizeBtn.textContent = originalText;
                    enableEditMode();
                }
            });
        }

        if (pdfBtn) {
            pdfBtn.addEventListener('click', async () => {
                if (pdfBtn.disabled) return;

                const element = document.querySelector('.a4-paper');
                const overlay = document.getElementById('pdfSuccessOverlay');

                const originalText = pdfBtn.textContent;
                pdfBtn.textContent = "Downloading...";
                pdfBtn.style.opacity = '0.7';

                const success = await generateQuestionPaperPDF(element, {
                    institution: currentDraft.institution || "School",
                    subject: currentDraft.subject
                });

                pdfBtn.textContent = originalText;
                pdfBtn.style.opacity = '1';

                if (success && overlay) {
                    overlay.classList.add('active');
                }
            });
        }
    </script>

    <script src="../assets/js/app_security.js"></script>
</body>

</html>