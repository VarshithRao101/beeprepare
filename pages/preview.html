<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preview - BEEPREPARE</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/animations.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- PDF Library -->
    <style>
        /* Compress width for mobile-like feel, similar to blueprint page */
        .page-container {
            max-width: 480px;
            margin: 0 auto;
            width: 100%;
        }
    </style>
</head>

<body>

    <div id="drawer">
        <!-- ... (Drawer content unchanged) ... -->
    </div>

    <div class="app-container">

        <!-- Header ... -->
        <header class="app-header">
            <div class="header-left">
                <a href="blueprint.html" class="menu-trigger" style="padding: 4px;">
                    <img src="../assets/images/icon-arrow-left.svg" alt="Back" style="width: 24px;">
                </a>
            </div>
            <div class="header-center">
                <h1 class="app-logo-text">Paper Preview</h1>
            </div>
            <div class="header-right">
                <a href="#" class="menu-trigger">
                    <img src="../assets/images/icon-edit.svg" alt="Edit" style="width: 20px; filter: grayscale(1);">
                </a>
            </div>
        </header>

        <main class="main-content fade-in" style="background-color: var(--dark-bg); position: relative;">

            <div class="preview-container-wrapper">

                <!-- A4 Paper Simulation -->
                <div class="a4-paper">

                    <!-- Paper Header -->
                    <div class="paper-header-section">
                        <!-- ... -->
                    </div>

                    <!-- ... Instructions ... -->

                    <!-- Paper Body -->
                    <div class="paper-question-list">
                        <!-- ... -->
                    </div>

                    <!-- ... Footer ... -->

                </div>
            </div>

            <!-- Scroll Spacer -->
            <div style="height: 60px;"></div>

        </main>

        <!-- ... Action Bar ... -->

    </div>

    <script type="module">
        import { getPaperDraft } from '../assets/js/createPaper.js';
        import { enableEditMode, disableEditMode, scrapePaperData } from '../assets/js/previewEditor.js';
        import { saveFinalPaper } from '../assets/js/paperSave.js';
        import { generateQuestionPaperPDF } from '../assets/js/pdfGenerator.js';

        // Global Draft Ref
        let currentDraft = null;

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Load Draft
            currentDraft = getPaperDraft();
            if (!currentDraft) {
                if (confirm("No active paper draft found. Create one now?")) {
                    window.location.href = "blueprint.html";
                }
                return;
            }

            // 2. Render Initial State
            renderPaper(currentDraft);

            // 3. Enable Editing Immediately
            enableEditMode();
        });

        const renderPaper = (draft) => {
            // Header rendering (unchanged)
            const headerSection = document.querySelector('.paper-header-section');
            if (headerSection) {
                headerSection.innerHTML = `
                    <div class="paper-inst-name">${draft.institution || "St. Xavier's High School"}</div>
                    <div class="paper-exam-name">${draft.examName || "Mid-Term Examination 2026"}</div>
                    
                    <div class="student-details-header">
                        <div class="detail-line">Name: <span></span></div>
                        <div class="detail-line">Roll No: <span></span></div>
                    </div>

                    <div class="paper-meta-grid">
                        <span>Class: ${draft.class} | Subject: ${draft.subject}</span>
                        <span>Marks: ${draft.totalMarks} | Time: ${Math.ceil(draft.totalMarks * 1.5)} Mins</span>
                    </div>
                `;
            }

            // Questions
            const container = document.querySelector('.paper-question-list');
            if (!container) return;
            container.innerHTML = '';

            let globalQCount = 1;

            const renderGroup = (label, typeFilter, marksDisplay) => {
                // Improved Filtering Logic
                let subset = [];

                if (typeFilter === "MCQ") {
                    subset = draft.questions.filter(q => q.questionType === "MCQ" || q.marks === "MCQ");
                } else {
                    subset = draft.questions.filter(q => q.marks == typeFilter && q.questionType !== "MCQ" && q.marks !== "MCQ");
                }

                if (subset.length === 0) return;

                // Section Header
                const sectionHeader = document.createElement('div');
                sectionHeader.style.cssText = "text-align: center; font-weight: 700; margin: 12px 0 8px 0; text-decoration: underline; font-size: 11pt;";
                sectionHeader.textContent = `${label} (${marksDisplay} Marks Each)`;
                container.appendChild(sectionHeader);

                subset.forEach(q => {
                    const el = document.createElement('div');
                    el.className = 'paper-question-item';
                    el.dataset.id = q.id || 'temp';

                    let optionsHtml = '';
                    if (q.options && typeof q.options === 'object') {
                        optionsHtml = `
                            <div class="mcq-options-grid">
                                <div class="mcq-option"><span>(A)</span> ${q.options.A}</div>
                                <div class="mcq-option"><span>(B)</span> ${q.options.B}</div>
                                <div class="mcq-option"><span>(C)</span> ${q.options.C}</div>
                                <div class="mcq-option"><span>(D)</span> ${q.options.D}</div>
                            </div>
                        `;
                    }

                    el.innerHTML = `
                        <div class="p-q-num">${globalQCount++}.</div>
                        <div class="p-q-content">
                            <div class="p-q-text">${q.questionText}</div>
                            ${optionsHtml}
                        </div>
                        <div class="p-q-marks">[${(q.marks === 'MCQ' || q.questionType === 'MCQ') ? 1 : q.marks}]</div>
                    `;
                    container.appendChild(el);
                });
            };

            if (draft.sectionOrder && Array.isArray(draft.sectionOrder)) {
                const sectionLabels = ["SECTION A", "SECTION B", "SECTION C", "SECTION D"];
                draft.sectionOrder.forEach((type, index) => {
                    let marksDisplay = type === "MCQ" ? 1 : parseInt(type);
                    if (isNaN(marksDisplay)) marksDisplay = 1;
                    renderGroup(sectionLabels[index], type, marksDisplay);
                });
            } else {
                // Fallback
                renderGroup("SECTION A", "MCQ", 1);
                renderGroup("SECTION B", "2", 2);
                renderGroup("SECTION C", "4", 4);
                renderGroup("SECTION D", "6", 6);
            }

            if (container.children.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px;">No questions in draft.</div>';
            }
        };

        // --- Interaction Logic ---
        const finalizeBtn = document.querySelector('.btn-primary');
        const pdfBtn = document.querySelector('.btn-disabled');

        if (finalizeBtn) {
            finalizeBtn.addEventListener('click', async () => {
                if (finalizeBtn.disabled) return;

                const originalText = finalizeBtn.textContent;
                finalizeBtn.textContent = "Saving...";
                finalizeBtn.disabled = true;

                try {
                    // 1. Scrape Final Data
                    const finalData = scrapePaperData(currentDraft);

                    // 2. Lock Editing
                    disableEditMode();

                    // 3. Save to Firestore
                    const paperId = await saveFinalPaper(finalData);

                    if (paperId) {
                        finalizeBtn.textContent = "Finalized";
                        // Update current draft with finalized data in case they want PDF right away
                        // scrapePaperData returns the structure we need
                        currentDraft = { ...currentDraft, ...finalData };

                        // Enable PDF Button
                        if (pdfBtn) {
                            pdfBtn.disabled = false;
                            pdfBtn.classList.remove('btn-disabled');
                            pdfBtn.classList.add('btn-primary');
                            pdfBtn.style.backgroundColor = 'var(--text-primary)';
                            pdfBtn.style.color = '#000';
                            pdfBtn.textContent = "Generate PDF";
                        }
                    } else {
                        throw new Error("Save returned null");
                    }

                } catch (e) {
                    console.error(e);
                    alert("Error finalizing paper: " + e.message);
                    finalizeBtn.disabled = false;
                    finalizeBtn.textContent = originalText;
                    enableEditMode();
                }
            });
        }

        if (pdfBtn) {
            pdfBtn.addEventListener('click', async () => {
                if (pdfBtn.disabled) return;

                const element = document.querySelector('.a4-paper');
                const overlay = document.getElementById('pdfSuccessOverlay');

                // Show loading
                const originalText = pdfBtn.textContent;
                pdfBtn.textContent = "Downloading...";
                pdfBtn.style.opacity = '0.7';

                const success = await generateQuestionPaperPDF(element, {
                    institution: currentDraft.institution || "School",
                    subject: currentDraft.subject
                });

                pdfBtn.textContent = originalText;
                pdfBtn.style.opacity = '1';

                if (success && overlay) {
                    overlay.classList.add('active');
                }
            });
        }
    </script>

</body>

</html>