<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="../assets/images/logo-icon.png">
    <title>Login - BEEPREPARE</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/animations.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: var(--spacing-md);
            background-color: var(--dark-bg);

        }

        .login-card {
            background-color: var(--card-grey);
            border: 1px solid var(--border-grey);
            border-radius: var(--radius-lg);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);

            animation: slideUpFadeIn 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .app-logo-large {
            font-size: 2rem;
            font-weight: 800;
            color: var(--yellow);
            margin-bottom: 8px;
            letter-spacing: -1px;
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 40px;
            font-size: 1rem;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background-color: #fff;
            color: #121212;
            font-weight: 600;
            font-size: 1rem;
            padding: 14px;
            border-radius: var(--radius-md);
            border: 1px solid #e0e0e0;


            width: 100%;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .google-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            background-color: #f8f9fa;
        }

        .google-btn:active {
            transform: scale(0.98);
        }

        .google-icon {
            width: 24px;
            height: 24px;
        }
    </style>
</head>

<body>

    <div class="login-container">
        <div class="login-card">
            <h1 class="app-logo-large">BEEPREPARE</h1>
            <p class="login-subtitle">Sign in with Google to continue</p>

            <button id="googleLoginBtn" class="google-btn" disabled style="opacity: 0.6; cursor: wait;">
                <span class="loader-mini"
                    style="margin-right:8px; border: 2px solid #333; border-top: 2px solid transparent; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block;"></span>
                Loading...
                <style>
                    @keyframes spin {
                        0% {
                            transform: rotate(0deg)
                        }

                        100% {
                            transform: rotate(360deg)
                        }
                    }
                </style>
            </button>
        </div>
    </div>


    <script>
        // Failsafe for module loading
        window.moduleLoaded = false;
        setTimeout(() => {
            const btn = document.getElementById('googleLoginBtn');
            if (!window.moduleLoaded && btn) {
                btn.innerHTML = "<span style='color:red'>Connection Failed</span>";
                alert("Unable to load Google Sign-In resources. Please check your internet connection.");
                const retryBtn = document.createElement('button');
                retryBtn.innerText = "Retry";
                retryBtn.onclick = () => window.location.reload();
                retryBtn.style.cssText = "display:block; margin: 10px auto; padding: 5px 10px;";
                btn.parentNode.appendChild(retryBtn);
            }
        }, 10000);
    </script>
    <script type="module">
        import { signInWithGoogle } from '../assets/js/firebase-auth.js';

        window.moduleLoaded = true;
        const btn = document.getElementById('googleLoginBtn');

        // Restore button state once loaded
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        btn.innerHTML = `<img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="google-icon"> Continue with Google`;

        const originalBtnContent = btn.innerHTML;

        btn.addEventListener('click', async () => {
            btn.disabled = true;
            btn.style.opacity = '0.7';
            btn.style.cursor = 'not-allowed';
            btn.innerHTML = `<span style="margin-right:8px">Connecting...</span>`;

            try {
                // Race condition to prevent infinite hanging
                const loginPromise = signInWithGoogle();
                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error("Request timed out. Please try again.")), 15000)
                );

                await Promise.race([loginPromise, timeoutPromise]);

            } catch (error) {
                console.error("Login Error:", error);

                // Show user friendly error via alert since they can't open console easily
                if (error.code === 'auth/popup-closed-by-user') {
                    // Ignore, user just closed it
                } else if (error.message && error.message.includes("timed out")) {
                    alert("Login timed out. Your connection might be slow. Please try again.");
                } else {
                    alert("Login Failed: " + (error.message || "Unknown error"));
                }

                // Reset button
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.innerHTML = originalBtnContent;
            }
        });
    </script>
    <script src="../assets/js/app_security.js"></script>
</body>

</html>